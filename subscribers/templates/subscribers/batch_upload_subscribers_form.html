{% extends 'accounts/base_app.html' %}

{% block content %}
   <div class="w3-container">

    <div class="panel-heading" id="raise-claim-form-heading">
        <h4 class="w3-center w3-text-blue">Follow the steps below to upload list of subscribers.</h4>
    </div>

    <div class="panel-body">
        <ul class="nav nav-tabs">
            <li class="active">
              <a href="#excel-format-container"
                 class="disabled-tab"
                 id="excel-format-tab"
                 data-toggle="tab" >
                <i class="fa fa-file-excel-o w3-text-green"></i> Excel format
              </a>
            </li>

            <li>
              <a href="#upload-file-container"
                 class="disabled-tab"
                 id="upload-file-tab"
                 data-toggle="tab">
                <i class="fa fa-upload w3-text-blue"></i> Upload excel file
              </a>
            </li>
            <li >
              <a href="#confirm-uploads-container"
                 class="disabled-tab"
                 id="confirm-uploads-tab" data-toggle="tab">
                <i class="fa fa-check-circle w3-text-orange"></i> Confirm list
              </a>
            </li>
            <li>
              <a href="#approve-subscribers-container"
                 class="disabled-tab"
                 data-toggle="tab" id="approve-subscribers-tab">
                <i class="fa fa-circle w3-text-teal"></i> Approve and upload
              </a>
            </li>
        </ul>

        <div class="tab-content">
            <div id="excel-format-container"
                  class="tab-pane fade in active">
              <h4  class="w3-text-blue">
                  Order of excel columns
              </h4>

              <a class="pull-right w3-text-green cursor-pointer" href="">
                Download excel template
              </a>
              <p>
                Use the order below to name the headers of the excel document.
              </p>
              <ul class="w3-ul w3-small">
                <li>1. First name <span class="w3-text-red">*</span></li>
                <li>2. Last name <span class="w3-text-red">*</span></li>
                <li>3. Mobile number <span class="w3-text-red">*</span> &nbsp; &nbsp;&nbsp; &nbsp;<span class="w3-tiny w3-text-deep-orange">07........</span></li>
                <li>4. Email address</li>
                <li>5. Country</li>
                <li>6. Date of birth &nbsp; &nbsp;&nbsp; &nbsp;<span class="w3-tiny w3-text-deep-orange">( YYYY-mm-dd )</span></li>
                <li>7. Gender <span class="w3-text-red">*</span>&nbsp; &nbsp;&nbsp; &nbsp;<span class="w3-tiny w3-text-deep-orange">Male or Female</span></li>
                <li>8. County</li>
                <li>9. Constituency</li>
                <li>10. Ward</li>
              </ul>
              <div class="w3-right">
                <a class="w3-btn w3-blue w3-text-white show-next-tab"
                   id="btn-move-to-upload-file"
                   data-value="upload-file-tab">
                  Next <i class="fa fa-arrow-right"></i>
                </a>
              </div>
            </div>

            <div id="upload-file-container"
                class="tab-pane fade in">
              <div class="col-lg-offset-1 col-lg-10 w3-card-2">
                <div class="w3-container w3-text-dark-grey">
                  <h4 class="w3-center">Fill the form below to upload subscribers</h4>
                </div>
                <br>
                <br>

                <form id="batch-subscribers-form"
                      enctype="form/multi-part"
                      class="w3-container w3-padding-4">
                  <br>
                  <div class="form-group">
                    <label class="w3-col l5 m4 s4">
                        <b>Attach excel file
                          <span class=" w3-small w3-text-orange"> .xlsx, .csv, .xls format</span>
                        </b> <span class="w3-text-red">*</span>
                    </label>
                    <div class="w3-rest">
                      <input class="w3-text-blue"
                         type="file"
                         accept=".xlsx, .xls, .csv"
                         id="batch-subscribers-list-file">
                      <span class="w3-text-red" id="batch-recipients-file-upload-response"></span>
                    </div>
                  </div>
                  <br>
                </form>

                <div>
                  <a class="w3-text-blue pull-left cursor-pointer show-back-tab" data-value="excel-format-tab">
                    <i class="fa fa-arrow-left"></i> Back
                  </a>
                  <a class="w3-btn w3-blue w3-text-white pull-right show-next-tab disabled-btn"
                     id="btn-upload-batch-file" data-value="confirm-uploads-tab">
                    Next <i class="fa fa-arrow-right"></i>
                  </a>
                </div>
                <br>
                <br>
              </div>
            </div>

            <div id="confirm-uploads-container"
              class="tab-pane fade in w3-responsive">
              <a class="w3-text-blue w3-tiny pull-left cursor-pointer show-back-tab"
                 data-value="upload-file-tab">
                <i class="fa fa-arrow-left"></i> Back
              </a>
              <a class="w3-text-blue pull-right cursor-pointer show-next-tab"
                 data-value="approve-subscribers-tab">
                 Next <i class="fa fa-arrow-right"></i>
              </a>
              <h4 class="w3-text-blue w3-center">
                  Subscribers to be uploaded
                  <span class="badge" id="num-of-subscribers"></span>
              </h4>
              <table class="w3-table w3-striped">
                <thead class="w3-text-white w3-grey">
                  <tr>
                    <th></th>
                    <th>First name</th>
                    <th>Last name</th>
                    <th>Mobile number</th>
                    <th>Country</th>
                    <th>Date of birth</th>
                    <th>Gender</th>
                    <th>County</th>
                    <th>Constituency</th>
                    <th>Ward</th>
                  </tr>
                </thead>
                <tbody id="data-rows"></tbody>
              </table>
              <br>
              <br>
              <div>
                <a class="w3-text-blue pull-left cursor-pointer show-back-tab" data-value="upload-file-tab">
                    <i class="fa fa-arrow-left"></i> Back
                </a>
                <a class="w3-btn w3-blue w3-text-white pull-right show-next-tab" data-value="approve-subscribers-tab">
                  Next <i class="fa fa-arrow-right"></i>
                </a>
              </div>
              <br>
              <br>
            </div>

            <div id="approve-subscribers-container"
              class="tab-pane fade in">
              <br>
              <div class="col-lg-offset-1 col-lg-10 w3-card-2">

                <form id="batch-subscribers-confirmation-form">
                  <div class="form-group">
                    <br>
                    <p>
                      Some  disclaimer here...
                    </p>
                  </div>
                  <div class="form-group">
                      <label class="w3-col l3 m3 s3">
                          <b>Enter your password </b> <span class="w3-text-red">*</span>
                      </label>
                      <div class="w3-rest">
                        <input class="w3-text-blue w3-input"
                               type="password"
                               autofocus
                               id="password"
                               placeholder="password">
                        <span class="w3-text-red" id="password-response"></span>
                      </div>
                  </div>
                </form>

                <div>
                  <a class="w3-text-blue pull-left cursor-pointer show-back-tab" data-value="confirm-uploads-tab">
                    <i class="fa fa-arrow-left"></i> Back
                  </a>
                  <a class="w3-btn w3-blue-gray w3-text-white pull-right"
                     id="btn-process-batch-subscribers-upload">
                     <i class="fa fa-circle w3-text-green"></i> Upload subscribers
                  </a>
                  <br>
                  <br>
                </div>
              </div>
              <br>
            </div>
        </div>
    </div>
   </div>
{% endblock %}

{% block extrahead %}
    <script>

     $(document).on('click', '.show-back-tab, #btn-move-to-upload-file, .show-next-tab', function(e){
       e.preventDefault();
       var nextTab = $(this).data('value');
       $('#'+nextTab).tab('show');
     });

    /***
     * Upload recipients excel document
     */

    var FILE_IS_SET = false;
    $(document).on('change', '#batch-subscribers-list-file', function (e) {
            e.preventDefault();
            UploadSubscribersFileData();
    });
    function UploadSubscribersFileData(){
        var fileSelect = document.getElementById('batch-subscribers-list-file');
        var file = fileSelect.files;
        var formData = new FormData();

        if(file[0].size/1000000 > 20){
          $('#batch-subscribers-list-file-response')
            .html('The file is too large. Ensure that it\'s at most 20mb')
            .addClass('w3-text-red')
            .removeClass('w3-text-green');
          return;
        }else{
            $('#batch-recipients-file-upload-response')
            .html('')
            .removeClass('w3-text-red');
        }

        var fileName = fileSelect.value.split(/(\\|\/)/g).pop();
        var extension = fileName.substring((fileName.lastIndexOf('.') + 1));
        var allowedExt = ['xlsx', 'xls', 'csv'];
        var extensionFoundAt = $.inArray(extension, allowedExt);

        if(extensionFoundAt === -1){
           $('#batch-subscribers-list-file-response')
            .html('Wrong file format. Use .xlsx, .xls, or .csv')
            .addClass('w3-text-red')
            .removeClass('w3-text-green');
          return;
        }else{
           $('#batch-recipients-file-upload-response')
            .html('')
            .removeClass('w3-text-red');
        }

        formData.append('file', file[0], file[0].name);
        formData.append('fileName', 'LIST_OF_SUBSCRIBERS');
        formData.append('csrfmiddlewaretoken',  '{{ csrf_token }}');

        var url = "{% url 'subscribers:upload_subscribers_file' %}";
        var xhr = new XMLHttpRequest();
        xhr.open('POST', url, true);

        xhr.onload = function(){
            if (xhr.status === 200){
                var responseObj = $.parseJSON(xhr.responseText);
                if(responseObj['STATUS'] === '1'){
                    $('#batch-recipients-file-upload-response')
                    .html('Number of subscribers : ' +responseObj['NUM_OF_RECORDS'])
                    .removeClass('w3-text-red')
                    .addClass('w3-text-green');
                    FILE_IS_SET = true;
                    $('#btn-upload-batch-file').removeClass('disabled-btn');
                    var data = responseObj['SUBSCRIBERS_LIST'];
                    var rows = '';
                    for(var i=0; i< data.length; i++){
                        rows += '<tr>'
                            +'<td>'+(i+1)+'</td>'
                            +'<td>'+data[i]['firstName']+'</td>'
                            +'<td>'+data[i]['lastName']+'</td>'
                            +'<td>'+data[i]['mobileNumber']+'</td>'
                            +'<td>'+data[i]['country']+'</td>'
                            +'<td>'+data[i]['dateOfBirth']+'</td>'
                            +'<td>'+data[i]['gender']+'</td>'
                            +'<td>'+data[i]['county']+'</td>'
                            +'<td>'+data[i]['constituency']+'</td>'
                            +'<td>'+data[i]['ward']+'</td>'
                            +'</tr>';
                    }
                    $('#data-rows').html(rows);
                    $('#num-of-subscribers').html(responseObj['NUM_OF_RECORDS']);
                }
                else{
                    FILE_IS_SET = false;
                     $('#btn-upload-batch-file').addClass('disabled-btn');
                }
            }else{

            }
        };
        xhr.send(formData);
    }

    $(document).on('click', '#btn-upload-batch-file', function(e){
        e.preventDefault();
        if(FILE_IS_SET === true){
            $('#confirm-uploads-tab').tab('show');
        }else{
            return;
        }
    });

    $(document).on('click', '#btn-process-batch-subscribers-upload', function(e){
        e.preventDefault();
        $('#btn-process-batch-subscribers-upload').prop('disabled', true);
        var password = $('#password').val();
        if(password.length < 8){
            $('#password').addClass('input-error');
            $('#btn-process-batch-subscribers-upload').prop('disabled', false);
            return;
        }else{
              $('#password').removeClass('input-error');
        }

        var srvRqst = $.ajax({
            url: "{% url 'subscribers:batch_approve_subscribers_from_file' %}",
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                password: password
            },
            type: 'post',
            datatype: 'json',
            beforeSend: function () {
                $('#btn-process-batch-subscribers-upload')
                    .html('<i class="fa fa-circle-o-notch fa-spin"></i> Loading...')
            }
        });

        srvRqst.done(function(response){
            try{
                var responseObj = $.parseJSON(response);
                if(responseObj['STATUS'] === '0'){
                    $('#password-response').html(responseObj['MESSAGE']);
                }else{
                    var html = '<ul class="w3-ul">';
                    var msgObj = responseObj['MESSAGE'];
                    for(var i=0; i< msgObj.length; i++){
                        var icon = '';
                        if(msgObj[i]['STATUS'] === '1'){
                            icon = '<i class="fa fa-circle w3-text-green"></i>';
                        }else{
                        icon = '<i class="fa fa-circle w3-text-red"></i>';
                        }
                        html += '<li>['+(i+1)+']'+icon+' '+msgObj[i]['MESSAGE']+'</li>';
                    }
                    html += '</ul>';
                    $('#page-modal-header').html('');
                    $('#page-modal-body').html(html);
                    $('#page-modal-footer').html('<a class="pull-left">'+responseObj['FINAL_MSG']+'</a>');
                    $('#page-modal').modal('show');

                    $('#batch-subscribers-confirmation-form').trigger('reset');
                    $('#batch-subscribers-form').trigger('reset');
                    $('#batch-recipients-file-upload-response').html('');
                    $('#data-rows').html('');
                    $('#num-of-subscribers').html('');
                    $('#excel-format-tab').tab('show');
                }
            }catch (exp){

            }finally {
                $('#btn-process-batch-subscribers-upload').prop('disabled', false)
                    .html('<i class="fa fa-circle w3-text-green"></i> Upload subscribers ');
            }
        });

        srvRqst.fail(function(jxHQR, errMsg, errThrown){
            $('#btn-process-batch-subscribers-upload')
                .html('<i class="fa fa-circle w3-text-green"></i> Upload subscribers ');
        });
    });
  </script>
{%  endblock %}
